version: '3'

tasks:

  download-digital-objects:
    desc: "Download digital object xml files from easydb"
    vars:
      DOWNLOAD_WHAT: "all"
    cmds:
      - for:
        - digital_object
        task: _download-module-items-from-easydb
        vars:
          MODULE: "{{.ITEM}}"
          DOWNLOAD_WHAT: "{{.DOWNLOAD_WHAT}}"

  _download-module-items-from-easydb:
    desc: Download data from EasyDB per module
    internal: true
    requires:
      vars: [MODULE, DOWNLOAD_WHAT]
    vars:
      FOLDER:
        sh: echo "/data/source/$(echo "{{.MODULE}}" | awk '{print tolower($0)}')"
      FILENAMEPREFIX:
        sh: echo "$(echo "{{.MODULE}}" | awk '{print tolower($0)}')-item-"
    cmds:
      - echo "Downloading {{.MODULE}} items from easydb"
      - mkdir -p {{.FOLDER}}
      - task: _download-items-from-easydb
        vars:
          MODULE: "{{.MODULE}}"
          OUTPUT_FOLDER: "{{.FOLDER}}"
          DOWNLOAD_WHAT: "{{.DOWNLOAD_WHAT}}"
          FILENAMEPREFIX: "{{.FILENAMEPREFIX}}"


  _download-items-from-easydb:
    internal: true
    requires:
      vars: [MODULE, OUTPUT_FOLDER, FILENAMEPREFIX, DOWNLOAD_WHAT]
    interactive: True
    cmds:
      - |
        python download_data_from_easydb.py \
          --login {{.LOGIN}} \
          --password {{.PASSWORD}} \
          --module {{.MODULE}} \
          --base_folder /data/source/ \
          --filenamePrefix {{.FILENAMEPREFIX}} \
          --downloadWhat {{.DOWNLOAD_WHAT}} \
          {{.CLI_ARGS}}

  download-images:
    desc: "Download and process images from CSV"
    vars:
      input_file: "{{.INPUT_FILE | default \"/data/iiif-20240818-loadfile-images-short.csv\"}}"
      offset: "{{.OFFSET | default \"0\"}}"
      limit: "{{.LIMIT | default \"10\"}}"
    cmds:
      - python downloadImages_grp.py --input-file={{.input_file}} --offset={{.offset}} --limit={{.limit}}
